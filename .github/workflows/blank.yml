name: Ultimate-Win10-CRD-with-Virtualization

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019
    steps:
      - name: Enable Virtualization Features
        shell: pwsh
        run: |
          # ØªÙØ¹ÙŠÙ„ Hypervisor Platform
          Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform -All -NoRestart
          
          # ØªÙØ¹ÙŠÙ„ Hyper-V (Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
          Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
          
          # ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø§Øª Windows Sandbox (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ virtualization)
          Enable-WindowsOptionalFeature -Online -FeatureName Containers-DisposableClientVM -All -NoRestart
          
          Write-Host "âœ… Virtualization features enabled!"

      - name: Download Chrome Installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait

      - name: Download and Install CRD
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

      - name: Download VirtualBox
        shell: pwsh
        run: |
          # ØªØ­Ù…ÙŠÙ„ VirtualBox
          Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.0.14/VirtualBox-7.0.14-161095-Win.exe" -OutFile "virtualbox.exe"
          
      - name: Install VirtualBox (Silent)
        shell: pwsh
        run: |
          # ØªØ«Ø¨ÙŠØª VirtualBox Ø¨ØµÙ…Øª Ù…Ø¹ ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª
          Start-Process -FilePath ".\virtualbox.exe" -Args "--silent --msiparams VBOX_INSTALLDESKTOPSHORTCUT=0 INSTALLDIR=""C:\VirtualBox""" -Wait
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± VirtualBox Ø¥Ù„Ù‰ Ø§Ù„Ù€ PATH
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH + ";C:\VirtualBox", "Machine")
          $env:PATH += ";C:\VirtualBox"
          
          Write-Host "âœ… VirtualBox installed successfully!"

      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME --pin=$env:CRD_PIN

      - name: Verify Virtualization
        shell: pwsh
        run: |
          Write-Host "=== Checking Virtualization Support ==="
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Hypervisor
          $hyperv = Get-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform
          Write-Host "HypervisorPlatform Status: $($hyperv.State)"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… AMD-V/Intel VT
          $cpu = Get-WmiObject Win32_Processor
          Write-Host "CPU: $($cpu.Name)"
          Write-Host "Virtualization Enabled in BIOS: $($cpu.VirtualizationFirmwareEnabled)"
          Write-Host "Second Level Address Translation: $($cpu.SecondLevelAddressTranslationExtensions)"
          
          # ØªØ´ØºÙŠÙ„ Ø£Ù…Ø± ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…
          systeminfo | Select-String -Pattern "Hyper-V"

      - name: Success Message
        shell: pwsh
        run: |
          Write-Host "======================================================"
          Write-Host "âœ… Windows 10 Environment with VirtualBox is READY!"
          Write-Host "ğŸ”— Go to: https://remotedesktop.google.com/access"
          Write-Host "ğŸ‘‰ Connect to the PC named '$Env:COMPUTERNAME' using your PIN."
          Write-Host "ğŸ‘‰ VirtualBox is installed at: C:\VirtualBox"
          Write-Host "======================================================"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
