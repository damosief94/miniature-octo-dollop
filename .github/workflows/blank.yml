name: Ultimate-Win10-CRD-with-Virtualization

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest  # Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø¯Ø¹Ù… Ù„Ù„Ù€ virtualization
    steps:
      - name: Enable Virtualization Features (No Restart)
        shell: pwsh
        run: |
          # ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù€ virtualization Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
          Write-Host "Enabling virtualization features..."
          
          # ØªÙØ¹ÙŠÙ„ Windows Hypervisor Platform (Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ù„Ù€ VirtualBox Ø¹Ù„Ù‰ Windows 10/Server)
          dism.exe /online /enable-feature /featurename:HypervisorPlatform /all /norestart
          
          # ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø§Øª Hyper-V Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          dism.exe /online /enable-feature /featurename:Microsoft-Hyper-V /all /norestart
          
          # ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø§Øª VM Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
          
          Write-Host "âœ… Virtualization features enabled without restart!"

      - name: Enable Nested Virtualization in Registry
        shell: pwsh
        run: |
          # ØªÙ…ÙƒÙŠÙ† Nested Virtualization ÙÙŠ Ø§Ù„Ø±ÙŠØ¬Ø³ØªØ±ÙŠ (Ù„Ù„Ù…Ø¶ÙŠÙÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†)
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v HypervisorEnforcedCodeIntegrity /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RequireSecureBoot /t REG_DWORD /d 0 /f
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙˆØ§ÙÙ‚
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity" /v Enabled /t REG_DWORD /d 0 /f
          
          Write-Host "âœ… Nested virtualization registry settings applied!"

      - name: Download Chrome Installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait

      - name: Download and Install CRD
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

      - name: Download and Install VirtualBox (With Fix)
        shell: pwsh
        run: |
          # ØªØ­Ù…ÙŠÙ„ VirtualBox
          Write-Host "Downloading VirtualBox..."
          Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.0.14/VirtualBox-7.0.14-161095-Win.exe" -OutFile "virtualbox.exe"
          
          # ØªØ«Ø¨ÙŠØª VirtualBox Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ©
          Write-Host "Installing VirtualBox with special parameters..."
          Start-Process -FilePath ".\virtualbox.exe" -Args "--silent --ignore-reboot --msiparams VBOX_INSTALLDESKTOPSHORTCUT=0 REBOOT=ReallySuppress" -Wait
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± VirtualBox Ø¥Ù„Ù‰ Ø§Ù„Ù€ PATH
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH + ";C:\Program Files\Oracle\VirtualBox", "Machine")
          $env:PATH = [Environment]::GetEnvironmentVariable("PATH", "Machine") + ";C:\Program Files\Oracle\VirtualBox"
          
          Write-Host "âœ… VirtualBox installed successfully!"

      - name: Configure VirtualBox for Windows Server
        shell: pwsh
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ØªÙƒÙˆÙŠÙ† Ù„Ù€ VirtualBox Ù„ØªØ¬Ø§ÙˆØ² Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ Hypervisor
          $vboxConfig = @"
# VirtualBox Configuration for Windows Server
VBoxManage setextradata global "VBoxInternal2/SvmEnable" "1"
VBoxManage setextradata global "VBoxInternal2/EnableNestedPaging" "1"
VBoxManage setextradata global "VBoxInternal2/Ept" "1"
VBoxManage setextradata global "VBoxInternal2/SvmAlwaysPassVmcbToGuest" "1"
"@
          
          # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù…Ù„Ù ØªÙ†ÙÙŠØ°ÙŠ
          $vboxConfig | Out-File -FilePath "C:\ConfigureVBox.bat" -Encoding ASCII
          
          Write-Host "âœ… VirtualBox configuration file created!"

      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME --pin=$env:CRD_PIN

      - name: Run VirtualBox Test
        shell: pwsh
        run: |
          Write-Host "=== Testing VirtualBox Installation ==="
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ«Ø¨ÙŠØª VirtualBox
          if (Test-Path "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe") {
              Write-Host "âœ… VirtualBox is installed"
              
              # Ø¹Ø±Ø¶ Ø¥ØµØ¯Ø§Ø± VirtualBox
              & "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" --version
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù€ virtualization
              Write-Host "`nChecking virtualization support..."
              
              # ÙØ­Øµ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              systeminfo | Select-String "Hyper-V"
              
          } else {
              Write-Host "âš ï¸ VirtualBox not found in default location"
          }
          
          Write-Host "`n=== Current Virtualization Status ==="
          bcdedit | Select-String "hypervisorlaunchtype"

      - name: Create VirtualBox Troubleshooting Script
        shell: pwsh
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø§Ø³ØªÙƒØ´Ø§Ù Ø£Ø®Ø·Ø§Ø¡ VirtualBox ÙˆØ¥ØµÙ„Ø§Ø­Ù‡Ø§
          $troubleshootScript = @"
@echo off
echo ========================================
echo VirtualBox Troubleshooting Script
echo ========================================
echo.

echo [1] Checking Hyper-V status...
bcdedit | findstr hypervisorlaunchtype

echo.
echo [2] Checking Windows Features...
dism /online /get-features | findstr /I "hypervisor"

echo.
echo [3] Checking VirtualBox installation...
if exist "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" (
    echo VirtualBox is installed.
    "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" --version
) else (
    echo VirtualBox is NOT installed.
)

echo.
echo [4] System Information (Virtualization related)...
systeminfo | findstr /I "virtualization"

echo.
echo [5] If VirtualBox shows errors, try disabling Hyper-V:
echo bcdedit /set hypervisorlaunchtype off
echo Then restart the system.

echo.
echo ========================================
echo Troubleshooting complete!
echo ========================================
pause
"@
          
          $troubleshootScript | Out-File -FilePath "C:\TroubleshootVBox.bat" -Encoding ASCII
          Write-Host "âœ… Troubleshooting script created at C:\TroubleshootVBox.bat"

      - name: Success Message
        shell: pwsh
        run: |
          Write-Host "======================================================"
          Write-Host "âœ… Windows Environment with VirtualBox is READY!"
          Write-Host "ğŸ”— Go to: https://remotedesktop.google.com/access"
          Write-Host "ğŸ‘‰ Connect to the PC named '$Env:COMPUTERNAME' using your PIN."
          Write-Host "ğŸ‘‰ VirtualBox is installed at: C:\Program Files\Oracle\VirtualBox"
          Write-Host ""
          Write-Host "âš ï¸ IMPORTANT FOR VIRTUALBOX:"
          Write-Host "If VirtualBox shows WHvCapabilityCodeHypervisorPresent errors:"
          Write-Host "1. Run C:\TroubleshootVBox.bat"
          Write-Host "2. Disable Hyper-V if not needed:"
          Write-Host "   bcdedit /set hypervisorlaunchtype off"
          Write-Host "3. Use VMware Workstation Player as alternative"
          Write-Host "======================================================"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) { 
            Write-Host "System is alive at $(Get-Date)"
            Start-Sleep -Seconds 300 
          }
