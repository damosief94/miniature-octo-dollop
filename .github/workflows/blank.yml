name: Ultimate-Win10-CRD-with-Virtualization

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019
    steps:
      - name: Enable Virtualization Features
        shell: pwsh
        run: |
          # ÿ™ŸÅÿπŸäŸÑ Hypervisor Platform ŸÅŸÇÿ∑
          Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform -All
          Write-Host "‚úÖ HypervisorPlatform enabled!"

      - name: Download Chrome Installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait

      - name: Download and Install CRD
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

      - name: Download VirtualBox
        shell: pwsh
        run: |
          # ÿ™ÿ≠ŸÖŸäŸÑ VirtualBox
          Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.0.14/VirtualBox-7.0.14-161095-Win.exe" -OutFile "virtualbox.exe"
          
      - name: Install VirtualBox (Silent)
        shell: pwsh
        run: |
          # ÿ™ÿ´ÿ®Ÿäÿ™ VirtualBox ÿ®ÿµŸÖÿ™
          Start-Process -FilePath ".\virtualbox.exe" -Args "--silent --msiparams VBOX_INSTALLDESKTOPSHORTCUT=0 INSTALLDIR=""C:\VirtualBox""" -Wait
          
          # ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿßÿ± VirtualBox ÿ•ŸÑŸâ ÿßŸÑŸÄ PATH
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH + ";C:\VirtualBox", "Machine")
          $env:PATH += ";C:\VirtualBox"
          
          Write-Host "‚úÖ VirtualBox installed successfully!"

      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME --pin=$env:CRD_PIN

      - name: Verify Virtualization
        shell: pwsh
        run: |
          Write-Host "=== Checking Virtualization Support ==="
          systeminfo | Select-String -Pattern "Hyper-V"

      - name: Success Message
        shell: pwsh
        run: |
          Write-Host "======================================================"
          Write-Host "‚úÖ Windows 10 Environment with VirtualBox is READY!"
          Write-Host "üîó Go to: https://remotedesktop.google.com/access"
          Write-Host "üëâ Connect to the PC named '$Env:COMPUTERNAME' using your PIN."
          Write-Host "üëâ VirtualBox is installed at: C:\VirtualBox"
          Write-Host "======================================================"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
